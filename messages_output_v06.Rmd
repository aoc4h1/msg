---
title: "Untitled"
output: html_document
date: "2022-09-22"
---

```{r setup, include=FALSE}
library(dplyr)
library(knitr)
library(ggplot2)
library(tidyr)
library(tibble)
library(hrbrthemes)
library(janitor)
library(ggrepel)
library(wordcloud)
library(tidyverse)
library(ggwordcloud)
library(wordcloud2)
library(tidytext)
library(ggtext)
library(webshot)
library(htmlwidgets)
library(htmltools)
knitr::opts_knit$set(progress = FALSE, verbose = FALSE)
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

<center>
# Hogy is volt ez a Messengeren?
## Több mint 6 év üzenetváltása
</center>
<br />

### Na, lássuk...

![alt text here](/Users/palmamogyorosi/Documents/Palma/Kreatív/2022 Barbi Messenger/_image/1_lassuk.jpg)


```{r napi_adat}
d1 <- data %>% 
  group_by(year,day) %>%
  count()
```

<br />
### Mennyi üzenetet váltottunk egy nap?
*Napi üzenetmennyiség 2015.04.22. - 2022.09.17. között*

```{r napi_plot, fig.width=11, fig.height=6.5}
ggplot(d1, aes(x=as.factor(day), y=n, fill=as.factor(year))) + 
  geom_col() +
  scale_fill_brewer(palette = "Spectral",name="") +
  scale_x_discrete(breaks=c("2016-01-01","2017-01-01","2018-01-01","2019-01-02","2020-01-02","2021-04-01","2022-04-01")) +
  theme_minimal() +
  theme(legend.position="bottom",legend.text = element_text(size=11, colour="#404040",margin = margin(r = 30)),
        axis.text = element_text(size=10), axis.text.y = element_text(margin = margin(r = 10)),
        axis.text.x = element_text(margin = margin(t = -5)),
        axis.title = element_blank(), plot.background = element_blank(),
        panel.grid.minor = element_blank(), panel.grid.major = element_blank()) +
  geom_vline(xintercept = "2016-10-01", linetype="dotted", size = 0.7) +
  annotate("text", x = "2016-10-01", y = Inf, label = "Első csók ", angle=90, vjust=2, hjust=1) +
  geom_vline(xintercept = "2018-08-01", linetype="dotted", size = 0.7) +
  annotate("text", x = "2018-08-01", y = Inf, label = "Összeköltözés ", angle=90, vjust=2, hjust=1) +
  geom_vline(xintercept = "2020-03-11", linetype="dotted", size = 0.7) +
  annotate("text", x = "2020-03-11", y = Inf, label = "COVID ", angle=90, vjust=2, hjust=1) +
  annotate("text", x = "2017-03-19", y = 1000, label = "Szülinapi buli másnapja \n (nem voltál ott!)", hjust=-0.1, size=3) +
  annotate("text", x = "2015-10-25", y = 380, label = "Barbi \nDánia", hjust=0.2, size=3) +
  annotate("text", x = "2021-06-27", y = 232, label = "Késik a\nLatorca IC", vjust=-0.7, size=3)
rm(d1)
```

<br />
### Szerinted pötyögtünk az év minden napján?
*2016-2021 teljes évek alapján [2016 szökőév]*

```{r ev_adat}
d2 <- data %>% group_by(year,day) %>% count() %>% 
  group_by(year) %>% count() %>% mutate(napok=365) %>% filter(year!=2015 & year!=2022)
d2$napok[which(d2$year==2016)] <- 366
d2 <- d2 %>% mutate(pct=n/napok)
d2$pct_nem <- 1-d2$pct

d2_1 <- select(d2,year,pct) %>% mutate(komm="Dumcsiztunk")
d2_2 <- select(d2,year,pct_nem) %>% mutate(komm="Nem dumcsiztunk") %>% rename(pct=pct_nem)
d2 <- rbind(d2_1,d2_2)
rm(d2_1,d2_2)
```

```{r ev_plot}
ggplot(d2, aes(x = year, y = pct, fill = komm)) + 
  geom_col(position = position_stack(reverse=TRUE), colour="white", size=1.3) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values=c("#46ABDE","#C7F9EE"),name="") +
  geom_text(aes(label=scales::percent(pct)), position=position_stack(reverse=TRUE, vjust=0.5), size=c(rep(4.5,6),rep(0,6)), col="white") +
  theme_minimal() +
  theme(legend.position="bottom",legend.text = element_text(size=11, colour="#404040",margin = margin(r = 30)),
        axis.text = element_text(size=11.5),
        axis.text.x = element_text(margin = margin(t = -5)),
        axis.title = element_blank(), plot.background = element_blank(),
        panel.grid.minor = element_blank(), panel.grid.major = element_blank()) +
  geom_vline(xintercept = c(4.5), linetype="dotted", size = 0.7) +
  annotate("text", x = c(4.5), y = Inf, label = "COVID ", vjust=1, hjust=-0.2)
rm(d2)
```

<br />
### Mikor chatelünk a legtöbbet?
*Nahát! Úgy tűnik, a hónap közepén és végén jellemzően több diskurálnivalónk van, mint a hónap elején - különösen az év második felében. Ez alól kivétel a szülinapom utáni 2 nap, akkor is ment a szöveg rendesen.*
*December 18. is aktív nap: talikat szerveztünk, cukiskodtunk, és vártuk a műtéted.*
*Május 13-án is sokat szoktunk beszélni, ezt két év húzza fel, 2017 és 2018. Közös bennük, hogy mindkét nap Nyíregyre utaztál/ott voltál, én mindkét alkalommal rossz közérzetről számoltam be, és mindig cukiskodtunk. '18-ban egy közös interjúgépelős projektről is beszéltünk és még lakásokat is nézegettünk.*

```{r heatmap_adat}
data$month_day <- substr(data$day,9,10)
data$month_num <- substr(data$day,6,7)

data$month_name <- ""
data$month_name[which(data$month_num=="01")] <- "Január"
data$month_name[which(data$month_num=="02")] <- "Február"
data$month_name[which(data$month_num=="03")] <- "Március"
data$month_name[which(data$month_num=="04")] <- "Április"
data$month_name[which(data$month_num=="05")] <- "Május"
data$month_name[which(data$month_num=="06")] <- "Június"
data$month_name[which(data$month_num=="07")] <- "Július"
data$month_name[which(data$month_num=="08")] <- "Augusztus"
data$month_name[which(data$month_num=="09")] <- "Szeptember"
data$month_name[which(data$month_num=="10")] <- "Október"
data$month_name[which(data$month_num=="11")] <- "November"
data$month_name[which(data$month_num=="12")] <- "December"

data$month_name <- as.factor(data$month_name)
data$month_name <- factor(data$month_name, levels =
            c("Január","Február","Március","Április","Május","Június","Július","Augusztus","Szeptember","Október","November","December"))

d3 <- data %>% group_by(month_day,month_name) %>% count()
```

```{r heatmap_plot, fig.width=11, fig.height=6}
d3  %>%
  ggplot(aes(d3$month_day, d3$month_name, fill= d3$n)) + 
  geom_tile() +
  theme_minimal() +
  scale_fill_distiller(palette = "YlGnBu", direction = 1, name="") +
  theme(legend.position="bottom",legend.text = element_text(size=11, colour="#404040",margin = margin(r = 30)),
      legend.key.height = unit(0.8, "cm"),
      legend.key.width = unit(2.5, "cm"),
      axis.text = element_text(size=11.5),
      axis.title = element_blank(), plot.background = element_blank(),
      panel.grid.minor = element_blank(), panel.grid.major = element_blank()) +
  annotate("text", x = "31", y = "November", label = "X", size=5, col="404040") +
  annotate("text", x = "31", y = "Szeptember", label = "X", size=5, col="404040") +
  annotate("text", x = "31", y = "Június", label = "X", size=5, col="404040") +
  annotate("text", x = "31", y = "Április", label = "X", size=5, col="404040") +
  annotate("text", x = "31", y = "Február", label = "X", size=5, col="404040") +
  annotate("text", x = "30", y = "Február", label = "X", size=5, col="404040")
rm(d3)
```

<br />
### Hívások aránya
*2020-ban már annyira untuk a képernyőt, hogy inkább hívtuk egymást.*

```{r type_adat}
d4 <- data %>% tabyl(year, type) %>%
  adorn_percentages("row") %>%
  select(., c(year, Call))
d4$year <- as.numeric(d4$year)
d4$Call <- as.numeric(d4$Call)
```

```{r type_plot, fig.width=9, fig.height=5}
ggplot(d4, aes(x=year, y=Call, label = paste0(round(Call * 100, 1), '%'))) +
  geom_line(color="#5C3368", size=1, linetype=1) +
  theme_minimal() +
  theme(axis.text = element_text(size=11.5), axis.title = element_blank(), 
        plot.background = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_continuous(label=scales::label_percent(.1)) +
  geom_label(size=3.5, col="#333333", hjust=0.5, fill="white", label.size=NA)
rm(d4)
```

<br />
### Milyen emojikat használunk?
*Én a szíveket, te meg a szemeket küldöd*

```{r emoji_adat}
d51 <- data %>% filter(sender_name=="Barbara Panyik") %>% unnest_tokens(word, text) %>% count(word, sort = TRUE) %>% 
  mutate(sender_name="Barbara Panyik")
d52 <- data %>% filter(sender_name=="Pálma Mogyorósi") %>% unnest_tokens(word, text) %>% count(word, sort = TRUE) %>% 
  mutate(sender_name="Pálma Mogyorósi")
d5 <- rbind(d51,d52)
rm(d51,d52)
d5$emoji <- startsWith(d5$word, "e_")
d5 <- subset(d5,emoji==T)
check <- d5 %>% group_by(word) %>% summarise(db=sum(n)) %>% arrange(desc(db))
emojis <- check$word[1:10]
d5 <- subset(d5, d5$word %in% emojis)
rm(check)

d5$word <- as.factor(d5$word)
d5$word <- factor(d5$word, levels = emojis)

# https://emojipedia.org/apple/

e_grinning_face_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/grinning-face_1f600.png' width='24'/>"
e_red_heart_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/red-heart_2764-fe0f.png' width='24'/>"
e_smiling_face_with_open_mouth_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/grinning-face-with-big-eyes_1f603.png' width='24'/>"
e_eyes_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/eyes_1f440.png' width='24'/>"
e_disappointed_face_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/disappointed-face_1f61e.png' width='24'/>"
e_face_with_open_mouth_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/face-with-open-mouth_1f62e.png' width='24'/>"
e_confused_face_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/confused-face_1f615.png' width='24'/>"
e_tongue_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/tongue_1f445.png' width='24'/>"
e_mouth_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/mouth_1f444.png' width='24'/>"
e_face_screaming_in_fear_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/face-screaming-in-fear_1f631.png' width='24'/>"
```

```{r emoji_plot, fig.width=11, fig.height=6}
ggplot(d5, aes(word, n, label = n)) +   
  geom_bar(aes(fill = sender_name), position = "dodge", stat="identity",  colour="white", size=0.3) +
  geom_text(position = position_dodge(width=1), aes(y=n+200, fill=sender_name, label=n, vjust=0.5), col="#333333") +
  theme_minimal() +
  theme(legend.position="top",legend.text = element_text(size=11, colour="#404040",margin = margin(r = 30)),
        axis.text = element_text(size=11.5), axis.text.x = element_blank(),
        axis.ticks.length = unit(1, "cm"),
        axis.title = element_blank(), plot.background = element_blank(),
        panel.grid.minor = element_blank(), panel.grid.major = element_blank()) +
  scale_fill_manual(values=c("#1F4797","#9BADFF"),name="") +
  annotate("richtext", x=1, y=0, label=e_grinning_face_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=2, y=0, label=e_red_heart_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=3, y=0, label=e_smiling_face_with_open_mouth_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=4, y=0, label=e_eyes_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=5, y=0, label=e_disappointed_face_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=6, y=0, label=e_face_with_open_mouth_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=7, y=0, label=e_confused_face_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=8, y=0, label=e_tongue_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=9, y=0, label=e_mouth_link, size=10, vjust=1, label.size = NA) +
  annotate("richtext", x=10, y=0, label=e_face_screaming_in_fear_link, size=10, vjust=1, label.size = NA) +
  coord_cartesian(ylim = c(0, 6000), clip="off")

rm(d5,e_grinning_face_link,e_red_heart_link,e_smiling_face_with_open_mouth_link,e_eyes_link,e_disappointed_face_link,e_face_with_open_mouth_link,e_confused_face_link,e_tongue_link,e_mouth_link,e_face_screaming_in_fear_link,emojis)
```
<br />
### "Love" emojik küldése a hónapok során
*Úgy tűnik, már a COVID előtt is lényegesen kevesebb szív emojit küldtünk az első pár évhez képest - de ne felejtsük el, hogy kevesebbet is chateltünk! Úgyhogy ez nem jelent semmit!!! <3 (Majd kiszámolom az arányokat is, jó?)*

```{r love_adat}
d6 <- data %>% select(month,text)
d6$heartcount <- str_count(d6$text,"e_red_heart")
d6$heartcount[which(is.na(d6$heartcount))] <- 0
d6 <- d6 %>% group_by(month) %>% summarise(n=sum(heartcount))
d6$colors <- "#C33329"
d6$colors[which(d6$month=="2020-03")] <- "darkgray"
d6$id <- as.numeric(rownames(d6))

label_data <- d6
number_of_bar <- nrow(label_data)
angle <-  90 - 360 * (as.numeric(label_data$id)-0.5) /number_of_bar
label_data$hjust<-ifelse( angle < -90, 1, 0)
label_data$angle<-ifelse(angle < -90, angle+180, angle)
label_data$fontcolor <- NA
label_data$fontcolor[which(label_data$month=="2015-04")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2016-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2017-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2018-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2019-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2020-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2021-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2022-01")] <- "darkgray"
label_data$fontcolor[which(label_data$month=="2017-07")] <- "#C33329"
label_data$fontcolor[which(label_data$month=="2017-05")] <- "#C33329"
label_data$fontcolor[which(label_data$month=="2017-06")] <- "#C33329"
label_data$fontcolor[which(label_data$month=="2020-03")] <- "darkgray"
label_data$month[which(label_data$month=="2020-03")] <- "COVID"

e_red_heart_link <- "<img src='https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/red-heart_2764-fe0f.png' width='24'/>"
```

```{r love_plot, fig.width=11, fig.height=6}
# Make the plot
# Note that id is a factor. If x is numeric, there is some space between the first bar
ggplot(d6, aes(x=as.factor(id), y=n)) +
  geom_bar(stat="identity", fill=d6$colors) +
  # Limits of the plot = very important. The negative value controls the size of the inner circle, the positive one is useful to add size over each bar
  ylim(-50,150) +
  # Custom the theme: no axis title and no cartesian grid
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-6.5,4), "cm")     # This remove unnecessary margin around plot
  ) +
  # This makes the coordinate polar instead of cartesian.
  coord_polar(start = 0) +
  geom_text(data=label_data, aes(x=id, y=n+5, label=paste0(month,"; ",n), hjust=hjust), color=label_data$fontcolor,
            fontface="bold",size=3, angle=label_data$angle, inherit.aes = FALSE) +
  annotate("richtext", x=0, y=-35, label=e_red_heart_link, size=10, vjust=1, label.size = NA)

rm(d6,label_data,e_red_heart_link,angle,number_of_bar)
```

<br />
### Szófelhő
*Jó öreg szófelhő*

```{r}
word <- c("a","nem","d","az","is","de","meg","és","hogy","van","vagy","h","volt","ez",
          "csak","ha","akkor","már","majd","dd","o","azt","lesz","es","hat","ddd","p","en","2","3","mar","még")
word <- data.frame(word)
colnames(hun.stopszavak) <- "word"
hun.stopszavak$word <- as.character(hun.stopszavak$word)
hun.stopszavak <- rbind(hun.stopszavak,word)

szavak <- data %>% unnest_tokens(word, text) %>% count(word, sort = TRUE) %>% anti_join(hun.stopszavak, by="word")
szavak$emoji <- startsWith(szavak$word,"e_")
szavak <- subset(szavak,emoji==F)
szavak$word[which(is.na(szavak$word))] <- ""

szavak$colors <- ""
x <- rep(rev(brewer.pal(11,"Spectral")),each=20)
szavak$colors[1:length(x)] <- x

my_graph <- wordcloud2(data=szavak, size=0.8, color=szavak$colors)
saveWidget(my_graph, "tmp.html", selfcontained = F)
#webshot("tmp.html", file = "wordcloud.png", delay=10, zoom=1, vwidth = 850, vheight = 550)

```

```{r, results='asis'}
htmltools::tags$iframe(title = "My embedded document", src = "tmp.html",height=600, width="100%")
```

```{r}
rm(szavak,word,x,my_graph)
```

```{r end}
knit2html("messages_output_v06.Rmd")
```

